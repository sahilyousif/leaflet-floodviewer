<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />

  <title>Flood Level Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
  <link href="css/nouislider.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="shortcut icon" href="">
  <link rel="stylesheet" href="css/jquery.simplecolorpicker.css">



</head>
<body>

  <div id='sidebar'>

    <div id="container">

      <div class="row">
       <div class="col s12">
        <p  class="">
          Select 10 year or 100 year period from the drop-down list.
        </p>
        <p  class="">
          Use the slider bar to see how various levels of sea level rise will impact the area.
        </p>
      </div>
    </div>

    <div class="row">
     
      <div class="col s10">
        <label>Flood Period</label><br>
        <div id="flood-period-input" ></div>

      </div>
      <div class="col s2">
        <div class="input-field">
          
          <select name="colorpicker" id="colorpicker">
            <option value="#fbd75b">Yellow</option>
            <option value="#a4bdfc">Blue</option>
            <option value="#ff887c">Red</option>
          </select>
          <label>Style</label>
        </div>

      </div>
      
    </div>
    <br><br>
    <div class="row">
     
      <div class="col s9">
        <label>Sea Level Rise</label><br>
        <div id="range-input" ></div>

      </div>
      <div class="col s3">
        <div id="slider-step-value"></div>
      </div>

    </div>
   

  </div>
</div>


</div>
<div id='map'></div>





<script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet-src.js"></script>
<script src="https://unpkg.com/esri-leaflet@2.0.7"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>
<script src="js/wNumb.js"></script>
<script src="js/nouislider.js"></script>
<script src="js/jquery.simplecolorpicker.js"></script>
<script>


var slider = document.getElementById('range-input');
noUiSlider.create(slider, {
 start: 0,
 connect: 'lower',
 step: 1,
 range: {
   min: 0,
   max: 5
 }
});

var period_slider = document.getElementById('flood-period-input');
noUiSlider.create(period_slider, {
 start: 0,
 connect: 'lower',
 step: 1,
 pips: {
    mode: 'count',
    values: 4,
    density: 30
  },
 range: {
   min: 1,
   max: 4
 }
});




var mymap = L.map('map').setView([46.966162,  -123.802774], 13);

L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic2FoaWx5b3VzaWYiLCJhIjoiY2l6Z3I2MDRjMDE4cjJ3bm5qZ2Z1Y3pqcCJ9.dGcoyBbChf6RIYv0-VWFKA', {
  maxZoom: 18,
  attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
  '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
  'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
  id: 'mapbox.streets'
}).addTo(mymap);



var layer = [];
var color_yellow = ['#FFF0C3','#FFDE9F','#FFBF40','#ECB240','#BE9440','#967940']
var color_blue = ['#CEDDFF','#96C5FF','#4094FF','#4085EC','#407ABE','#405C96']
var color_red = ['#FFCECE','#FF9F9F','#FF4040','#EC4040','#BE4040','#964040']
current_slider_val = 0;
var year = 10;
rain30 = false;

color = color_yellow;

layer[0] = L.esri.featureLayer({
  url: "https://services7.arcgis.com/pKm55wmvxVfTe8RD/arcgis/rest/services/floodplain_yellow/FeatureServer/3",
  style: function () {
    return { color: color[0], weight: 1, opacity: 1, fillOpacity:0.8 };
  }
}).addTo(mymap);



var stepSliderValueElement = document.getElementById('slider-step-value');


// handle flood level Slider
slider.noUiSlider.on('update', function( values, handle ) {
  stepSliderValueElement.innerHTML = parseInt(values[handle]) + " ft";
  if (year == 10){
    delta = 3;
  } else {
    delta = 17;
  }
  if (rain30){
    delta = delta + 7;
  }

  if(parseInt(values[handle]) > current_slider_val){
    for(var i=current_slider_val+1;i<=parseInt(values[handle]);i++)
    {
      console.log("adding layer " + year + "yr. Feature Layer: " + (i+delta))
      layer[i] = L.esri.featureLayer({
        url: "https://services7.arcgis.com/pKm55wmvxVfTe8RD/arcgis/rest/services/floodplain_yellow/FeatureServer/" + (parseInt(values[handle])+delta),
        style: function () {
          return { color: color[i-1], weight: 1, opacity: 1, fillOpacity:0.8 };
        }
      }).addTo(mymap);
    }
  }

  if(parseInt(values[handle]) < current_slider_val){
    for(var i=current_slider_val;i>parseInt(values[handle]);i--)
    {
      console.log("removing layer " + year + "yr. Feature Layer: " + (i+delta))
      mymap.removeLayer(layer[i])
    }
  }
  current_slider_val = parseInt(values[handle])
});



// handle ColorPicker
$('select[name="colorpicker"]').simplecolorpicker({
  picker: true
}).on('change', function() {
  
  if($('select[name="colorpicker"]').val() == "#a4bdfc"){
    color = color_blue;
  } else if ($('select[name="colorpicker"]').val() == "#fbd75b"){
    color = color_yellow;
  } else if ($('select[name="colorpicker"]').val() == "#ff887c"){
    color = color_red;
  }
  for(var i=0;i<=parseInt(slider.noUiSlider.get());i++){
    layer[i].setStyle({color:color[i], weight: 1, opacity: 1, fillOpacity:0.8})
  }
});


// label period slider
 $('.noUi-value.noUi-value-horizontal.noUi-value-large').each(function(){
        var val = $(this).html();
        val = recountVal(parseInt(val));
        $(this).html(val);
    });

    function recountVal(val){
        switch(val){
            case 1: return '10yr'; break;
            case 2:return '10yr+30%';break;
            case 3:return '100yr';break;
            case 4:return '100yr+30%';break;
            default :return '$10 M';break;
        }
    }

// handle Period Slider
period_slider.noUiSlider.on('update', function( values, handle ) {
   slider.noUiSlider.set(0);
  if(parseInt(values[handle]) == 1 || parseInt(values[handle]) == 2)
  {
    year = 10;
  } else {
    year = 100;
  }

  if(parseInt(values[handle]) == 2 || parseInt(values[handle]) == 4)
  {
    rain30 = true;
    console.log("30% inc rain enabled")

  } else {
    rain30 = false;
    console.log("30% inc rain disabled")

  }

  mymap.removeLayer(layer[0])
  
  if (year == 10) {
    delta = 3;
  } else {
    delta = 17;
  }

  if (rain30){
    delta = delta + 7;
  }

  console.log("layer 0 changed to " + year + "yr. Feature Layer: " + delta)
  layer[0] = L.esri.featureLayer({
    url: "https://services7.arcgis.com/pKm55wmvxVfTe8RD/arcgis/rest/services/floodplain_yellow/FeatureServer/" + delta,
    style: function () {
      return { color: color[0], weight: 1, opacity: 1, fillOpacity:0.8 };
    }
  }).addTo(mymap);
});

</script>
</body>
</html>